name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  # Check PR metadata
  pr-metadata:
    name: PR Metadata Check
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - name: Check PR title
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          if [[ ! "$PR_TITLE" =~ ^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\(.+\))?: ]]; then
            echo "âŒ PR title does not follow conventional commits format"
            echo "Expected format: type(scope): description"
            echo "Types: feat, fix, docs, style, refactor, test, chore, perf, ci, build, revert"
            exit 1
          else
            echo "âœ… PR title follows conventional commits format"
          fi

      - name: Check PR description
        run: |
          PR_BODY="${{ github.event.pull_request.body }}"
          if [ -z "$PR_BODY" ] || [ ${#PR_BODY} -lt 50 ]; then
            echo "âŒ PR description is too short (minimum 50 characters)"
            exit 1
          else
            echo "âœ… PR description is adequate"
          fi

  # File changes analysis
  analyze-changes:
    name: Analyze File Changes
    runs-on: ubuntu-latest
    outputs:
      backend-changed: ${{ steps.filter.outputs.backend }}
      frontend-changed: ${{ steps.filter.outputs.frontend }}
      docker-changed: ${{ steps.filter.outputs.docker }}
      docs-changed: ${{ steps.filter.outputs.docs }}
      migration-changed: ${{ steps.filter.outputs.migration }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'backend/**'
              - 'requirements*.txt'
            frontend:
              - 'frontend/**'
              - 'package*.json'
            docker:
              - 'docker-compose.yml'
              - '**/Dockerfile'
              - '.dockerignore'
            docs:
              - '**/*.md'
              - 'docs/**'
            migration:
              - 'backend/alembic/**'
              - 'backend/app/models/**'

  # Run tests conditionally
  conditional-tests:
    name: Run Relevant Tests
    needs: analyze-changes
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - test: backend
            condition: ${{ needs.analyze-changes.outputs.backend-changed == 'true' }}
          - test: frontend
            condition: ${{ needs.analyze-changes.outputs.frontend-changed == 'true' }}

    steps:
      - name: Skip if no changes
        if: matrix.condition == false
        run: echo "Skipping ${{ matrix.test }} tests - no relevant changes"

      - name: Checkout code
        if: matrix.condition == true
        uses: actions/checkout@v6

      - name: Run backend tests
        if: matrix.test == 'backend' && matrix.condition == true
        run: |
          echo "Running backend tests..."
          # Simplified test command for PR checks
          cd backend
          # Add actual test commands here

      - name: Run frontend tests
        if: matrix.test == 'frontend' && matrix.condition == true
        run: |
          echo "Running frontend tests..."
          # Simplified test command for PR checks
          cd frontend
          # Add actual test commands here

  # Code quality check
  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        continue-on-error: true

      - name: Check for code complexity
        run: |
          echo "Checking code complexity..."
          # Add complexity checks here

  # Database migration check
  migration-check:
    name: Database Migration Check
    needs: analyze-changes
    if: needs.analyze-changes.outputs.migration-changed == 'true'
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: kobetsu_admin
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: kobetsu_test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt

      - name: Test migration up
        env:
          DATABASE_URL: postgresql://kobetsu_admin:test_password@localhost:5432/kobetsu_test_db
        run: |
          cd backend
          alembic upgrade head
          echo "âœ… Migration upgrade successful"

      - name: Test migration down
        env:
          DATABASE_URL: postgresql://kobetsu_admin:test_password@localhost:5432/kobetsu_test_db
        run: |
          cd backend
          alembic downgrade -1
          echo "âœ… Migration downgrade successful"

      - name: Test migration idempotency
        env:
          DATABASE_URL: postgresql://kobetsu_admin:test_password@localhost:5432/kobetsu_test_db
        run: |
          cd backend
          alembic upgrade head
          alembic upgrade head  # Should be idempotent
          echo "âœ… Migration is idempotent"

  # Bundle size check for frontend
  bundle-size:
    name: Bundle Size Check
    needs: analyze-changes
    if: needs.analyze-changes.outputs.frontend-changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          cd frontend
          npm ci

      - name: Build and analyze bundle
        run: |
          cd frontend
          npm run build

          # Check build size
          echo "Checking bundle size..."
          TOTAL_SIZE=$(du -sh .next | cut -f1)
          echo "Total build size: $TOTAL_SIZE"

          # Add size limit checks here
          # Example: fail if > 10MB
          SIZE_BYTES=$(du -sb .next | cut -f1)
          if [ $SIZE_BYTES -gt 10485760 ]; then
            echo "âŒ Bundle size exceeds 10MB limit"
            exit 1
          fi
          echo "âœ… Bundle size is within limits"

  # PR summary comment
  pr-summary:
    name: Post PR Summary
    runs-on: ubuntu-latest
    needs: [pr-metadata, analyze-changes, conditional-tests, code-quality]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Generate PR summary
        id: summary
        run: |
          echo "## Pull Request Check Summary" > pr-summary.md
          echo "" >> pr-summary.md
          echo "### ðŸ“ Changed Components" >> pr-summary.md
          echo "" >> pr-summary.md

          if [ "${{ needs.analyze-changes.outputs.backend-changed }}" == "true" ]; then
            echo "- âœ… Backend changes detected" >> pr-summary.md
          fi

          if [ "${{ needs.analyze-changes.outputs.frontend-changed }}" == "true" ]; then
            echo "- âœ… Frontend changes detected" >> pr-summary.md
          fi

          if [ "${{ needs.analyze-changes.outputs.docker-changed }}" == "true" ]; then
            echo "- ðŸ³ Docker configuration changes detected" >> pr-summary.md
          fi

          if [ "${{ needs.analyze-changes.outputs.migration-changed }}" == "true" ]; then
            echo "- ðŸ—„ï¸ Database migration changes detected" >> pr-summary.md
          fi

          if [ "${{ needs.analyze-changes.outputs.docs-changed }}" == "true" ]; then
            echo "- ðŸ“š Documentation changes detected" >> pr-summary.md
          fi

          echo "" >> pr-summary.md
          echo "### âœ… Check Results" >> pr-summary.md
          echo "" >> pr-summary.md

          # Add test results
          echo "| Check | Status |" >> pr-summary.md
          echo "|-------|--------|" >> pr-summary.md
          echo "| PR Metadata | ${{ needs.pr-metadata.result }} |" >> pr-summary.md
          echo "| Tests | ${{ needs.conditional-tests.result }} |" >> pr-summary.md
          echo "| Code Quality | ${{ needs.code-quality.result }} |" >> pr-summary.md

          echo "" >> pr-summary.md
          echo "### ðŸ“Š Code Coverage" >> pr-summary.md
          echo "" >> pr-summary.md
          echo "Coverage reports will be available once all tests complete." >> pr-summary.md

          echo "" >> pr-summary.md
          echo "---" >> pr-summary.md
          echo "*Generated by GitHub Actions at $(date -u)*" >> pr-summary.md

      - name: Post PR comment
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('pr-summary.md', 'utf8');

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Pull Request Check Summary')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: summary
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: summary
              });
            }