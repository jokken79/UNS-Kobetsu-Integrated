name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v1.2.3)'
        required: true
        type: string

permissions:
  contents: write
  packages: write
  issues: write
  pull-requests: write

jobs:
  # Create release
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      release-url: ${{ steps.release.outputs.url }}
      release-id: ${{ steps.release.outputs.id }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"

      - name: Generate changelog
        id: changelog
        run: |
          # Generate changelog from commits since last tag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -z "$PREVIOUS_TAG" ]; then
            echo "No previous tag found, including all commits"
            COMMITS=$(git log --pretty=format:"- %s (%an)" --no-merges)
          else
            echo "Generating changelog from $PREVIOUS_TAG to ${{ steps.version.outputs.version }}"
            COMMITS=$(git log --pretty=format:"- %s (%an)" --no-merges ${PREVIOUS_TAG}..${{ steps.version.outputs.version }} 2>/dev/null || git log --pretty=format:"- %s (%an)" --no-merges ${PREVIOUS_TAG}..HEAD)
          fi

          # Create changelog file
          cat > CHANGELOG.md <<EOF
          # Release ${{ steps.version.outputs.version }}

          ## What's Changed

          ### Features
          $(echo "$COMMITS" | grep -E "^- (feat|feature)" || echo "No new features")

          ### Bug Fixes
          $(echo "$COMMITS" | grep -E "^- (fix|bugfix)" || echo "No bug fixes")

          ### Documentation
          $(echo "$COMMITS" | grep -E "^- (docs|doc)" || echo "No documentation changes")

          ### Other Changes
          $(echo "$COMMITS" | grep -vE "^- (feat|feature|fix|bugfix|docs|doc)" || echo "No other changes")

          ## Contributors
          $(git log ${PREVIOUS_TAG}..HEAD --pretty=format:"%an" | sort -u | sed 's/^/- @/')

          **Full Changelog**: https://github.com/${{ github.repository }}/compare/${PREVIOUS_TAG}...${{ steps.version.outputs.version }}
          EOF

          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          cat CHANGELOG.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        id: release
        uses: actions/github-script@v8
        with:
          script: |
            const release = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: '${{ steps.version.outputs.version }}',
              name: 'Release ${{ steps.version.outputs.version }}',
              body: `${{ steps.changelog.outputs.changelog }}`,
              draft: false,
              prerelease: ${{ contains(steps.version.outputs.version, '-') }},
              generate_release_notes: true
            });

            core.setOutput('url', release.data.html_url);
            core.setOutput('id', release.data.id);
            return release.data;

  # Build release artifacts
  build-artifacts:
    name: Build Release Artifacts
    runs-on: ubuntu-latest
    needs: create-release
    strategy:
      matrix:
        include:
          - name: backend
            path: backend
          - name: frontend
            path: frontend
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Create tarball for ${{ matrix.name }}
        run: |
          tar -czf ${{ matrix.name }}-${{ needs.create-release.outputs.version }}.tar.gz -C ${{ matrix.path }} .

      - name: Create zip for ${{ matrix.name }}
        run: |
          cd ${{ matrix.path }}
          zip -r ../${{ matrix.name }}-${{ needs.create-release.outputs.version }}.zip .
          cd ..

      - name: Upload artifacts to release
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');

            // Upload tar.gz
            await github.rest.repos.uploadReleaseAsset({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: ${{ needs.create-release.outputs.release-id }},
              name: '${{ matrix.name }}-${{ needs.create-release.outputs.version }}.tar.gz',
              data: fs.readFileSync('${{ matrix.name }}-${{ needs.create-release.outputs.version }}.tar.gz')
            });

            // Upload zip
            await github.rest.repos.uploadReleaseAsset({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: ${{ needs.create-release.outputs.release-id }},
              name: '${{ matrix.name }}-${{ needs.create-release.outputs.version }}.zip',
              data: fs.readFileSync('${{ matrix.name }}-${{ needs.create-release.outputs.version }}.zip')
            });

  # Build and publish Docker images
  publish-docker:
    name: Publish Docker Images
    runs-on: ubuntu-latest
    needs: create-release
    strategy:
      matrix:
        service: [backend, frontend]
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
        continue-on-error: true

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ghcr.io/${{ github.repository_owner }}/uns-kobetsu-${{ matrix.service }}
            docker.io/${{ secrets.DOCKER_USERNAME }}/uns-kobetsu-${{ matrix.service }}
          tags: |
            type=semver,pattern={{version}},value=${{ needs.create-release.outputs.version }}
            type=semver,pattern={{major}}.{{minor}},value=${{ needs.create-release.outputs.version }}
            type=semver,pattern={{major}},value=${{ needs.create-release.outputs.version }}
            type=raw,value=latest,enable=${{ !contains(needs.create-release.outputs.version, '-') }}

      - name: Build and push ${{ matrix.service }}
        uses: docker/build-push-action@v6
        with:
          context: ./${{ matrix.service }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ needs.create-release.outputs.version }}
            BUILD_DATE=${{ github.event.repository.updated_at }}
            VCS_REF=${{ github.sha }}

  # Update documentation
  update-docs:
    name: Update Documentation
    runs-on: ubuntu-latest
    needs: create-release
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Update version in documentation
        run: |
          # Update version references in documentation
          find . -name "*.md" -type f -exec sed -i "s/v[0-9]\+\.[0-9]\+\.[0-9]\+/${{ needs.create-release.outputs.version }}/g" {} +

          # Update package.json version
          cd frontend
          npm version ${{ needs.create-release.outputs.version }} --no-git-tag-version

          # Update Python package version if exists
          if [ -f "backend/setup.py" ]; then
            sed -i "s/version=\".*\"/version=\"${{ needs.create-release.outputs.version }}\"/" backend/setup.py
          fi

      - name: Create PR for documentation updates
        uses: peter-evans/create-pull-request@v7
        with:
          title: "docs: Update documentation for ${{ needs.create-release.outputs.version }}"
          body: |
            This PR updates the documentation and version references for release ${{ needs.create-release.outputs.version }}.

            ## Changes
            - Updated version references in documentation
            - Updated package.json version
            - Updated any other version references

            Auto-generated by release workflow.
          branch: docs/update-for-${{ needs.create-release.outputs.version }}
          commit-message: "docs: Update for release ${{ needs.create-release.outputs.version }}"
          labels: documentation, automated

  # Send notifications
  notify:
    name: Send Release Notifications
    runs-on: ubuntu-latest
    needs: [create-release, publish-docker]
    if: always()
    steps:
      - name: Send success notification
        if: needs.publish-docker.result == 'success'
        run: |
          echo "✅ Release ${{ needs.create-release.outputs.version }} published successfully!"
          echo "Release URL: ${{ needs.create-release.outputs.release-url }}"
          # Add actual notification logic here (Slack, Discord, email, etc.)

      - name: Send failure notification
        if: needs.publish-docker.result != 'success'
        run: |
          echo "❌ Release ${{ needs.create-release.outputs.version }} failed!"
          # Add actual notification logic here